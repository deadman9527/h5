!function(a,b){function c(a,b){if(h[a])return void b(h[a]);var c=[{id:"",name:"我不清楚",pid:a}];lib.api.get({api:{c:"user",a:"get_area"},needLogin:!1,data:{area_id:a},success:function(c){c.data&&b(c.data),console.log(c),h[a]=c.data},error:function(d){console.error(d),b(c),h[a]=c}})}function d(a){var b={},d={},e=a.id||1,f=a.deep||4,h=a.onReady,i={4:"province",3:"city",2:"area",1:"street"};c(e,function(a){var e=i[f],j=null;d[e]=[],a.forEach(function(a,b){!g.content.address_detail[e]||-1==a.name.indexOf(g.content.address_detail[e])&&-1==g.content.address_detail[e].indexOf(a.name)||(j=b);var c={key:a.name,value:a.id,selected:b===(j||0)};d[e].push(c)}),b[e]=d[e][j||0],f--,1>f?h&&h(d):c(b[e].value,arguments.callee)})}function e(a,b){b=b||{};var c=ctrl.selectmenu;f=new c({confirmText:b.confirmText||"确定",title:b.title||"",cancelText:b.opts||"取消",trigger:b.trigger,verifyMe:function(){return!i}}),f.viewModel=a,f.addEventListener("confirm",function(){console.log(i),i||b.onConfirm(this.selectedValue)}),f.addEventListener("select",function(a){var b=this.selectedValue["val-"+a],c=this;console.log(i),i=!0,"province"==a?d({id:b,deep:3,onReady:function(a){c.linkage("city",a.city),c.linkage("area",a.area),c.linkage("street",a.street)}}):"city"==a?d({id:b,deep:2,onReady:function(a){c.linkage("area",a.area),c.linkage("street",a.street)}}):"area"==a?d({id:b,deep:1,onReady:function(a){c.linkage("street",a.street)}}):"street"==a&&(i=!1)}),document.body.appendChild(f.root)}var f,g,h={},i=!1;b.selectAddress={init:function(b){a.ajax({type:"GET",url:"http://api.map.baidu.com/location/ip?ak=7LKIOX88UcaHWrMDzN7coBub&coor=bd09ll&qt=loc&callback=?",data:{name:"Zepto",type:"JSONP"},success:function(a){g=a,d({onReady:function(a){e(a,b)}})},error:function(){console.log("Ajax error!"),d({onReady:function(a){e(a,b)}},{content:{address_detail:{province:"浙江省",city:"杭州市"}}})}})}}}(Zepto,window.app||(window.app={})),function(a){var b={init:function(){var b=new lib.httpurl(location.href),c=b.params,d=c.title?decodeURIComponent(c.title):"新增地址";document.title=d,new ctrl.topBar({isIndex:!1,title:d}),this.pro=null,this.toConfirm=parseInt(c.toConfirm),this.proType=parseInt(c.proType),c.isDirect&&(this.isDirect=parseInt(c.isDirect)),lib.storage.get("editAddressData")&&(a("#provice").css("color","#333"),console.log(lib.storage.get("editAddressData")),this.id=lib.storage.get("editAddressData").id||"",this.username=lib.storage.get("editAddressData").name||"",this.phone=lib.storage.get("editAddressData").phone||"",this.addressDet=lib.storage.get("editAddressData").address||"",this.proId=lib.storage.get("editAddressData").province_id||"",this.cityId=lib.storage.get("editAddressData").city_id||"",this.areaId=lib.storage.get("editAddressData").area_id||"",this.streetId=lib.storage.get("editAddressData").street_id||"",this.pro=lib.storage.get("editAddressData").province||"",this.city=lib.storage.get("editAddressData").city||"",this.area=lib.storage.get("editAddressData").area||"",this.street=lib.storage.get("editAddressData").town||"",this.pro&&a("#provice").html(this.pro+""+this.city+this.area+this.street),a("#username").val(this.username),a("#phone").val(this.phone),a("#addressDet").val(this.addressDet),lib.storage.rm("editAddressData"),this.action=this.isDirect?"address":"editaddress"),this.render(),this.brandId=c.brandId||0,this.categoryId=c.categoryId||0},render:function(){var b=this;app.selectAddress.init({confirmText:"",title:"",cancelText:"",trigger:document.getElementById("provice"),onConfirm:function(c){b.pro=c,console.log(b.pro),console.log(b.pro["key-city"]),a("#provice").css("color","#333"),a("#provice").html((c["key-province"]||"")+(c["key-city"]||"")+(c["key-area"]||"")+c["key-street"]||"")}});var b=this;a(".save-btn").click(function(){b.submit()})},submit:function(){var a=this;a.verify()&&(a.isAjax||(console.log(a.pro),a.isAjax=!0,lib.api.get({needLogin:!0,api:{c:"user",a:a.action||"address"},data:{city:a.pro["val-city"]||a.cityId,address:a.addressDet,name:a.name,phone:a.phone,provice:a.pro["val-province"]||a.proId,area:a.pro["val-area"]||a.areaId,town:a.pro["val-street"]||a.streetId,id:a.id||null},success:function(b){lib.storage.set("addressSelectedId",b.addr_id),console.log(a.toConfirm),a.isDirect||a.toConfirm?location.href="order-confirm.html?proType="+a.proType:history.go(-1),console.log(b)},error:function(a){a&&a.desc&&console.log(a.desc),console.error(a)},complete:function(){a.isAjax=!1}})))},verify:function(){return this.name=a("#username").val(),this.phone=a("#phone").val(),this.addressDet=a("#addressDet").val(),this.name=this.name.trim(),this.addressDet=this.addressDet.trim(),0==this.name.length?(lib.notification.simple("收货人不能为空","",1e3),!1):this.name.length>12?(lib.notification.simple("用户名长度不能超过12个字符","",1e3),!1):/^(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/.test(this.phone)?0==this.addressDet.length?(lib.notification.simple("详细地址不能为空","",1e3),!1):null==this.pro||""==this.pro?(lib.notification.simple("省市区不能为空","",1e3),!1):!0:(lib.notification.simple("手机格式错误","",1e3),!1)}};a(function(){b.init()})}(Zepto,window.Global||(window.Global={}));