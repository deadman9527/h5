!function(win,lib){function getParam(t){var e=$("#J_search .cc-search-tab li.cur").html(),a="宝贝"==e?"hbword":"店铺"==e?"hshopword":"tmallword";return a=a+t+"%23h%23search"}var localStorage;try{localStorage=win.localStorage,localStorage.setItem("@private","false")}catch(e){localStorage=null}var $=win.$,queueHandler=function(){var t=this,e=setInterval(function(){if(t.Queue.length>0&&!t.stop){var a=t.Queue.shift();a.fn(a.argument),a.callBack&&a.callBack()}else clearInterval(e)},this.setTimeout)},queue={Queue:[],syncQueue:[],setTimeout:100,add:function(t,e,a){return this.Queue.push({fn:t,argument:e,callBack:a}),this},addSync:function(t,e,a){return this.syncQueue.push({fn:t,argument:e,callBack:a}),this},clear:function(){return this.Queue=[],this},stop:!1,start:function(){return this.stop=!1,this.setTimeout>0&&queueHandler.apply(this),this},shift:function(){},dequeue:function(){var t=this.syncQueue.shift();t&&(t.fn(t.argument),t.callBack&&t.callBack())}};$.fn.autoComplete=function(options){var self=this,setting={ajaxUrl:"http://m.taobao.com",operator:".J_autocomplete",cat:".J_cat",wrapEl:".wrap",meatEl:".meat",childEl:"li",submit:".btn",close:".close",collapse:"collapse",expand:"expand",delay:0,anim:!0,isUseKey:!0,history:!1,localStorage:"searchhistory",clearHistory:"clear",addition:!1,additionClass:".addition",max:7,onFocus:function(){},afterItemClick:function(){},textInput:function(){},onHisLoad:function(){}};$.extend(setting,options||{});var autoComplete={ajax:[],hisList:[],hisIndex:0,onHisLoad:setting.onHisLoad};return $(this).each(function(){function initInput(t){var e,t=t||window.event;if(e=$(this).val().replace(/(^\s+)|(\s+$)/g,""),!e.length&&setting.history)return queue.clear(),queue.add(getHistory),void queue.start();if(13!=t.keyCode&&32!=t.keyCode){setting.textInput.call(this,e.length);var a=self.find("#J_ST"),s=a.attr("name");return a.length>0&&"event_submit_do_search_shop"==s?(self.find(setting.wrapEl).hide(),!1):void("close"!==setting.status&&(queue.clear(),queue.add(getList,e),queue.start()))}}function getList(t){var e=setting.ajaxUrl;autoComplete.ajax.push($.ajax({url:e,type:"GET",dataType:"jsonp",data:"code=utf-8&extras=1&q="+t,error:function(){return!1},success:function(t){pack(t),$close.html("关闭").removeClass("clear")}}))}function getHistory(){var t=autoComplete.hisList[autoComplete.hisIndex];pack(t),$close.html("清除历史记录").addClass("clear")}function clearHistory(){if(setting.localStorage&&localStorage)localStorage.removeItem(setting.localStorage);else{var t="string"==typeof setting.clearHistory?[setting.clearHistory]:setting.clearHistory;queue.clear();for(var e=0;e<t.length;e++)queue.addSync($.ajax,{url:t[e],dataType:"jsonp",success:function(){queue.dequeue()}});queue.dequeue()}autoComplete.hisList=[]}function pack(t){var e=[],a=[],s=[],i=[],n=t&&t.minitao,o=t&&t.cat,l=t&&t.result,r=!1;if(setting.isUseKey&&self.find("#J_IsUseSearchSuggest").val(""),setting.status||(setting.status=t&&t.result&&0===t.result.length?"close":t&&t.status),n){for(var c=0;c<n.length;c++){var u=n[c][0],d=Number(n[c][1]),h=n[c][2];d>=1e4&&(d/=1e4,d=d.toFixed(1)+"万"),a.push('<li class="we" key="'+h+'">'),a.push('<div class="logo we"></div>'),a.push('<div class="title"> <span class="grey name">微淘</span> <span>'+u+'</span> <span class="grey type">'+d+"关注者</span></div>"),a.push('<div class="arrow"></div>'),a.push("</li>")}r=!0}if(o){for(var p=0;p<o.length;p++){var f=o[p][2],g=o[p][1],m=o[p][0];a.push('<li catmap="'+g+'" key="'+f+'">'),a.push('<div class="logo cat"></div>'),a.push('<div class="title"><span>'+f+'</span> <span class="grey name">分类</span> <span class="grey type">'+m+"</span></div>"),a.push('<div class="arrow"></div>'),a.push("</li>")}r=!0}if(t&&0!=t.result&&t.result.length>0){for(var v=l.length>setting.max?setting.max:l.length,c=(setting.addition?"<div class='"+setting.additionClass.slice(1)+"'></div>":"",0);v>c;c++)i.push('<li key="'+l[c][0]+'"><div class="title">'+l[c][0]+"</div></li>");r=!0}return r?(e.push(s.join("")+a.join("")+i.join("")),self.find(setting.meatEl).html(e.join("")),effect(),void 0):void self.find(setting.wrapEl).hide()}function effect(){var t=null;t=setTimeout(function(){setting.anim?self.find(setting.wrapEl).show():self.removeClass(setting.collapse).addClass(setting.expand)},setting.delay),self.find(setting.close).unbind("click"),self.find(setting.childEl).unbind("click"),self.find(setting.close).click(function(){var t=null;t=setTimeout(function(){setting.anim?self.find(setting.wrapEl).hide():self.removeClass(setting.expand).addClass(setting.collapse)},setting.delay),$close.hasClass("clear")&&(logAjax("","clean"),clearHistory())}),self.find(setting.childEl).click(function(){var t=$(this),e=t.attr("key"),a=t.attr("catmap")||"";if(setting.afterItemClick.call(this,Number(t.index())+1),t.hasClass("we"))location.href="http://h5.m.taobao.com/we/index.htm#account/"+e;else{operator.val(e),$(setting.cat).val(a);var s=self.find(setting.submit)[0];s&&s.click()}})}function toTop(){return}function logAjax(t,e){var a="http://log.mmstat.com/search",s=document.cookie,i=s&&s.match("_w_tb_nick=.*"),n=e||"",o=i&&i[0].split(";")[0].split("=")[1]||"",l="smtaobao",r=t||"",c="sug";$.ajax({url:a,data:{op:n,nk:o,src:l,q:r,app:c},error:function(){return console.log("网络连接失败，请刷新页面重试"),!1},success:function(){}})}var self=$(this);if(setting.history)if(setting.localStorage&&localStorage)autoComplete.hisList=eval(localStorage.getItem(setting.localStorage)||[]);else{for(var hisArray="string"==typeof setting.history?[setting.history]:setting.history,i=0;i<hisArray.length;i++)queue.addSync($.ajax,{url:hisArray[i],type:"GET",dataType:"jsonp",error:function(){return console.log("网络连接失败，请刷新页面重试"),!1},success:function(t){autoComplete.hisList.push(t),queue.dequeue()}});queue.addSync(autoComplete.onHisLoad),queue.dequeue()}var operator=$(this).find(setting.operator),$close=self.find(setting.close).addClass("c-btn-grey-small s-btn-grey");operator.attr("autocomplete","off"),operator.on("input",initInput),operator.focus(function(t){var e;return""==$(this).val()&&$(this).val(""),e=$(this).val().replace(/(^\s+)|(\s+$)/g,""),setting.onFocus&&setting.onFocus.call(operator,t,e),0==e.length&&setting.history?(queue.clear(),queue.add(getHistory),void queue.start()):void 0}),setting.addition&&self.find(setting.meatEl).on("touchstart click","div"+setting.additionClass,function(t){var e=$(this);operator.focus(),operator.val(e.parent().attr("key")),initInput.call(operator),t.preventDefault(),t.stopPropagation()}),autoComplete.getHistory=setting.history?function(){queue.clear(),queue.add(getHistory),queue.start()}:function(){},autoComplete.close=function(){if(queue.clear(),autoComplete.ajax.length){for(i=0;i<autoComplete.ajax.length;i++)autoComplete.ajax[i]&&autoComplete.ajax[i].abort();autoComplete.ajax=[]}self.find(setting.wrapEl).hide()},autoComplete.initInput=initInput}),autoComplete},lib.autocomplete={template:['<section id="J_search" class="in-search cc-search showoff">','<div class="cc-search-hide">','<a class="cc-back">关闭</a>','<ul class="cc-search-tab">','<li class="cur" i="event_submit_do_new_search_auction">宝贝</li>','<li i="event_submit_do_search_shop">店铺</li>','<li i="event_submit_do_new_search_tmall_auction">天猫</li>',"</ul>","</div>",'<div id="J_dropdown" class="c-form-suggest">','<div class="c-form-search">','<form id="J_indexform" name="wapSearchForm" action="http://s.m.taobao.com/h5.htm?pds=hbword0%23h%23search" method="get" autocomplete="off">','<input id="J_searchtext" class="inp-search" name="q" value="" autocomplete="off" />','<a id="J_cleartext" class="clearText"><span></span></a>','<input type="submit" value="" name="search-bton" class="bton-search" />','<input type="hidden" id="J_ST" name="event_submit_do_new_search_auction" value="1" />','<input type="hidden" value="utf-8" name="_input_charset" />','<input type="hidden" value="1" name="topSearch" />','<input type="hidden" value="b" name="atype" />','<input type="hidden" value="1" name="searchfrom" />','<input type="hidden" value="home:redirect_app_action" name="action" />','<input type="hidden" value="1" name="from" />','<input type="hidden" name="ttid" />',"</form>","</div>",'<div class="suggest"><ul class="meat"></ul><span class="close">关闭</span></div>',"</div>","</section>"].join(""),init:function(t,e){$(this.template).appendTo(document.body),e||(e={});var a=$("#J_dropdown").autoComplete({ajaxUrl:"http://suggest.taobao.com/sug",wrapEl:".suggest",operator:".inp-search",meatEl:".suggest .meat",close:".suggest .close",submit:".bton-search",addition:!0,anim:!0,history:!0,clearHistory:!0,onFocus:function(){i.val(""),s.removeClass("showoff"),$(t).hide()},textInput:function(){i.val().length?n.css("visibility","visible"):n.css("visibility","hidden")},afterItemClick:function(t){var e=getParam(t);o.attr("action","http://s.m.taobao.com/h5?pds="+e+"&suggest="+encodeURIComponent($(this).text())+"_"+t+"&q="+encodeURIComponent($(this).text()))}}),s=$("#J_search"),i=$("#J_searchtext"),n=$("#J_cleartext"),o=$("#J_indexform"),l=$("#J_ST");i.attr("placeholder",e.title||""),s.on("click","#J_cleartext",function(){i.val(""),n.css("visibility","hidden"),s.find(".suggest").hide()}),s.on("click",".cc-back",function(){s.addClass("showoff"),$(t).show()}),s.on("click",".cc-search-tab li",function(){var t=$(this),e=t.attr("i");if(!t.hasClass("cur"))switch(l[0].setAttribute("name",e),t.addClass("cur").siblings(".cur").removeClass("cur"),o.attr("action","http://s.m.taobao.com/index.htm?pds="+getParam(0)),t.html()){case"店铺":a.hisIndex=1,a.getHistory();break;case"天猫":a.hisIndex=2,a.getHistory();break;default:a.hisIndex=0,a.getHistory()}}),s.on("submit","#J_indexform",function(){var t=i[0];e.searchkey||(e.searchkey="");var s=t.value?t.value:e.searchkey;if(t.value=s,""===s)return notification.simple("请输入关键字"),!1;if($("#J_indexform").attr("action",$("#J_indexform").attr("action")),localStorage){var n="searchhistory";ls=localStorage.getItem(n);var o=ls&&JSON.parse(ls)||[],l=a.hisIndex,r=o.length>l&&o[l]||{result:[]},c=$.map(r.result,function(t,e){return t[0]==s||e>6?null:[t]});c.unshift([s]),r.result=c,o[l]=r,localStorage.setItem(n,JSON.stringify(o))}})}}}(window,window.lib||(window.lib={}));