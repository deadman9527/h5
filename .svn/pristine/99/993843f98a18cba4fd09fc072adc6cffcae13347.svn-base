!function(e,t){function i(e,t){if(n[e])return void t(n[e]);var i=[{id:"",name:"我不清楚",pid:e}];lib.api.get({api:{c:"user",a:"get_area"},needLogin:!1,data:{area_id:e},success:function(i){i.data&&t(i.data),console.log(i),n[e]=i.data},error:function(a){console.error(a),t(i),n[e]=i}})}function a(e){var t={},a={},s=e.id||1,r=e.deep||4,n=e.onReady,d={4:"province",3:"city",2:"area",1:"street"};i(s,function(e){var s=d[r],c=null;a[s]=[],e.forEach(function(e,t){!o.content.address_detail[s]||-1==e.name.indexOf(o.content.address_detail[s])&&-1==o.content.address_detail[s].indexOf(e.name)||(c=t);var i={key:e.name,value:e.id,selected:t===(c||0)};a[s].push(i)}),t[s]=a[s][c||0],r--,1>r?n&&n(a):i(t[s].value,arguments.callee)})}function s(e,t){t=t||{};var i=ctrl.selectmenu;r=new i({confirmText:t.confirmText||"确定",title:t.title||"",cancelText:t.opts||"取消",trigger:t.trigger,verifyMe:function(){return!d}}),r.viewModel=e,r.addEventListener("confirm",function(){console.log(d),d||t.onConfirm(this.selectedValue)}),r.addEventListener("select",function(e){var t=this.selectedValue["val-"+e],i=this;console.log(d),d=!0,"province"==e?a({id:t,deep:3,onReady:function(e){i.linkage("city",e.city),i.linkage("area",e.area),i.linkage("street",e.street)}}):"city"==e?a({id:t,deep:2,onReady:function(e){i.linkage("area",e.area),i.linkage("street",e.street)}}):"area"==e?a({id:t,deep:1,onReady:function(e){i.linkage("street",e.street)}}):"street"==e&&(d=!1)}),document.body.appendChild(r.root)}var r,o,n={},d=!1;t.selectAddress={init:function(t){e.ajax({type:"GET",url:"http://api.map.baidu.com/location/ip?ak=7LKIOX88UcaHWrMDzN7coBub&coor=bd09ll&qt=loc&callback=?",data:{name:"Zepto",type:"JSONP"},success:function(e){o=e,a({onReady:function(e){s(e,t)}})},error:function(){console.log("Ajax error!"),a({onReady:function(e){s(e,t)}},{content:{address_detail:{province:"浙江省",city:"杭州市"}}})}})}}}(Zepto,window.app||(window.app={})),function(e){var t={init:function(){var t=new lib.httpurl(location.href),i=t.params,a=i.title?decodeURIComponent(i.title):"新增地址";document.title=a,new ctrl.topBar({isIndex:!1,title:a}),this.pro=null,this.toConfirm=parseInt(i.toConfirm),this.proType=parseInt(i.proType),i.isDirect&&(this.isDirect=parseInt(i.isDirect)),lib.storage.get("editAddressData")&&(e("#provice").css("color","#333"),console.log(lib.storage.get("editAddressData")),this.id=lib.storage.get("editAddressData").id||"",this.username=lib.storage.get("editAddressData").name||"",this.phone=lib.storage.get("editAddressData").phone||"",this.addressDet=lib.storage.get("editAddressData").address||"",this.proId=lib.storage.get("editAddressData").province_id||"",this.cityId=lib.storage.get("editAddressData").city_id||"",this.areaId=lib.storage.get("editAddressData").area_id||"",this.streetId=lib.storage.get("editAddressData").street_id||"",this.pro=lib.storage.get("editAddressData").province||"",this.city=lib.storage.get("editAddressData").city||"",this.area=lib.storage.get("editAddressData").area||"",this.street=lib.storage.get("editAddressData").town||"",this.pro&&e("#provice").html(this.pro+""+this.city+this.area+this.street),e("#username").val(this.username),e("#phone").val(this.phone),e("#addressDet").val(this.addressDet),lib.storage.rm("editAddressData"),this.action=this.isDirect?"address":"editaddress"),this.render(),this.brandId=i.brandId||0,this.categoryId=i.categoryId||0},render:function(){var t=this;app.selectAddress.init({confirmText:"",title:"",cancelText:"",trigger:document.getElementById("provice"),onConfirm:function(i){t.pro=i,console.log(t.pro),console.log(t.pro["key-city"]),e("#provice").css("color","#333"),e("#provice").html((i["key-province"]||"")+(i["key-city"]||"")+(i["key-area"]||"")+i["key-street"]||"")}});var t=this;e(".save-btn").click(function(){t.submit()})},submit:function(){var e=this;e.verify()&&(e.isAjax||(console.log(e.pro),e.isAjax=!0,lib.api.get({needLogin:!0,api:{c:"user",a:e.action||"address"},data:{city:e.pro["val-city"]||e.cityId,address:e.addressDet,name:e.name,phone:e.phone,provice:e.pro["val-province"]||e.proId,area:e.pro["val-area"]||e.areaId,town:e.pro["val-street"]||e.streetId,id:e.id||null},success:function(t){lib.storage.set("addressSelectedId",t.addr_id),console.log(e.toConfirm),e.isDirect||e.toConfirm?location.href="order-confirm.html?proType="+e.proType:history.go(-1),console.log(t)},error:function(e){e&&e.desc&&console.log(e.desc),console.error(e)},complete:function(){e.isAjax=!1}})))},verify:function(){return this.name=e("#username").val(),this.phone=e("#phone").val(),this.addressDet=e("#addressDet").val(),this.name=this.name.trim(),this.addressDet=this.addressDet.trim(),0==this.name.length?(lib.notification.simple("收货人不能为空","",1e3),!1):this.name.length>12?(lib.notification.simple("用户名长度不能超过12个字符","",1e3),!1):/^(13[0-9]|15[012356789]|17[678]|18[0-9]|14[57])[0-9]{8}$/.test(this.phone)?0==this.addressDet.length?(lib.notification.simple("详细地址不能为空","",1e3),!1):null==this.pro||""==this.pro?(lib.notification.simple("省市区不能为空","",1e3),!1):!0:(lib.notification.simple("手机格式错误","",1e3),!1)}};e(function(){t.init()})}(Zepto,window.Global||(window.Global={}));