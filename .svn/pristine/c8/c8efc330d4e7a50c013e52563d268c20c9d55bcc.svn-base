!function(a){Global.formatImgSrc=function(a){if(!a)return"http://h5.ve.cn/assets/img/cart_img_black_640x253.png";var b=a.match(/^http:\/\/img\.ve\.cnttp(.+)_3\.jpg/);return b?"http"+b[1]+".jpg":a};var b={init:function(){var b=new lib.httpurl(location.href),c=b.params,d=c.title?decodeURIComponent(c.title):"确认订单";document.title=d,new ctrl.topBar({isIndex:!1,title:d}),this.proType=parseInt(c.proType)||0,this.code=c.code||0,this.id=c.id||0,this.value=c.value||0,this.duringPay=!1,lib.lazyload.init(),this.addEvents(),this.render(),this.bottombar=new ctrl.bottomBar({showBottom:!0});var e=window.navigator.userAgent.toLowerCase();e.match(/MicroMessenger/i)?a(".weixinpay").css("display","block"):a(".weixinpay").hide(),new lib.goTop},addEvents:function(){var b=this;a(".radio").on("click",function(){if(!a(this).hasClass("radio-active")){var b=a(this).attr("name");a(".radio[name="+b+"]").removeClass("radio-active"),a(this).addClass("radio-active")}}),a(".delivery-title").on("click",function(){a(this).find(".arrow-right").hasClass("arrow-down")?(a(this).find(".arrow-right").removeClass("arrow-down"),a(".delivery-content").hide()):(a(this).find(".arrow-right").addClass("arrow-down"),a(".delivery-content").show())}),a(".delivery-content .radio").unbind("click"),a(".delivery-content .select-row").on("click",function(){a(this).find(".radio-active")[0]||(console.log("change"),a(".delivery-content .radio-active").removeClass("radio-active"),a(this).find(".radio").addClass("radio-active"),a(".delivery-text").html(a(this).text())),a(".delivery-content").hide(),a(".delivery-title .arrow-right").removeClass("arrow-down")}),a(".invoice-title").on("click",function(){a(this).find(".arrow-right").hasClass("arrow-down")?(a(this).find(".arrow-right").removeClass("arrow-down"),a(".invoice-content").hide()):(a(this).find(".arrow-right").addClass("arrow-down"),a(".invoice-content").show())}),a(".payinfo").on("click",function(){var c=20,d=null;if("alipay"==a(this).attr("paytype")?c=20:"wxpay"==a(this).attr("paytype")&&(c=25,d="http://pay.api.ve.cn"),!b.duringPay)if(b.duringPay=!0,b.paragram={source:"h5",in_app:0,order_type:b.proType-0+1},b.paragram.pay_type=c,b.paragram.addr_id=a(".address-container").attr("data-id"),b.paragram.mess=a(".delivery-text").text(),b.code&&(b.paragram.code=b.code),b.id&&(b.paragram.coupon_id=b.id),b.paragram.is_invoices=a('.invoice-content .radio-active[name="type"]').index()>1?1:0,b.paragram.is_invoices&&(b.paragram.invoices_type=a('.invoice-content .radio-active[name="type"]').index()-2,b.paragram.invoices_cpy=a(".invoice-content .invoice-input").val(),b.paragram.invoices_class=a('.invoice-content .radio-active[name="content"]').index()),b.paragram.addr_id)lib.api.get({api:{c:"order",a:"add_User_Order"},needLogin:!0,apiUrl:d,data:b.paragram,success:function(a){console.log(a),lib.h5log.log(["setCustomVariable",5,"orderSn",a.order_sn,"page"]),setTimeout(function(){window.location.href=a.html_url},100)},error:function(a){var b=lib.notification.alert(a.desc,function(){this.hide()},{useTap:!0});b.show()},complete:function(){b.duringPay=!1}});else{var e=lib.notification.alert("请添加收货地址",function(){this.hide()},{useTap:!1});e.show()}})},render:function(){var b=this;b.isAjax||(b.isAjax=!0,lib.api.get({api:{c:"shoping",a:"get_User_Cart"},needLogin:lib.login.isLogin(),data:{accessToken:""},success:function(c){if(console.log(c),b.proType&&!c.is_sea_order){var d=lib.notification.alert(c.sea_limit_message,function(){this.hide(),window.location.href="cart.html?type=2"},{useTap:!0});d.show()}var e=b.proType?c.sea_products:c.products;e&&e[0]?(b.renderNext(),b.renderItems(c),b.renderSum(c),b.renderCoupon(c),a(".coupon-row").attr("href","coupon-select.html?total="+(b.proType?c.sea_total_price:c.total_price)+(b.code?"&code="+b.code:"")+(b.proType?"&proType=1":""))):window.location.href="order-list.html#status=1"},error:function(a){var b=lib.notification.alert(a.desc,function(){this.hide(),window.location.href="order-list.html"},{useTap:!0});b.show()},complete:function(){b.isAjax=!1}}))},renderNext:function(){var b=this;lib.login.isLogin()?lib.login.isLogin()?lib.api.get({api:{c:"user",a:"getaddress"},needLogin:!0,data:{},success:function(c){console.log(c),lib.storage.set("addressList",c);var d=c.addresses[0];if(lib.storage.get("addressSelectedId"))for(var e=0;e<c.addresses.length;e++)c.addresses[e].id==lib.storage.get("addressSelectedId")&&(d=c.addresses[e]);b.renderAddress(d),a(".container").show(),a(".loading").hide()},error:function(c){(c.code="00007")&&(b.renderAddress(),a(".container").show(),a(".loading").hide())},complete:function(){b.isAjax=!1}}):b.renderAddress():(b.renderAddress(),a(".container").show(),a(".loading").hide())},checkNeedScroll:function(){return!this.is_have},renderAddress:function(b){var c=a("#address"),d=this,e=a("#tpl-address").html();c.prepend(_.template(e)({addressData:b,proType:d.proType,isLogin:lib.login.isLogin()}))},renderItems:function(b){var c=this.proType?b.sea_products:b.products;for(var d in c){var e=0;for(var f in c[d].orders)e+=c[d].orders[f].price*c[d].orders[f].num;c[d].sum=e}var g=this.proType?b.sea_total_price:b.total_price,h=a("#orders"),i=a("#tpl-goods").html();h.append(_.template(i)({products:c,proType:this.proType,total_price:g})),lib.lazyload.trigger()},renderSum:function(b){var c=a(".pay-container"),d=a("#tpl-pay").html();c.prepend(_.template(d)({data:b,value:this.value,proType:this.proType}))},renderCoupon:function(b){var c=a(".coupon-container"),d=a("#tpl-coupon").html(),e=lib.login.isLogin();c.prepend(_.template(d)({data:b,proType:this.proType,isLogin:e})),this.code&&(a(".coupon-row .unselected").remove(),a(".coupon-row").append('<span class="select-content">'+this.value+"元优惠券</span>"))},renderError:function(a){switch(a){case"param":this.showTip("缺少必要参数");break;case"network":this.showTip("服务器开小差啦");break;case"empty":this.showTip("当前条件，列表为空")}},showTip:function(b){var c=a(".info-tip");c.html(b).show()}};a(function(){b.init()})}(Zepto,window.Global||(window.Global={}));