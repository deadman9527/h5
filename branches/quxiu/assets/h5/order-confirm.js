!function(e){Global.formatImgSrc=function(e){if(!e)return"http://h5.quxiu.me/assets/img/cart_img_black_640x253.png";var i=e.match(/^http:\/\/img\.ve\.cnttp(.+)_3\.jpg/);return i?"http"+i[1]+".jpg":e};var i={init:function(){var i=new lib.httpurl(location.href),t=i.params,r=t.title?decodeURIComponent(t.title):"确认订单";document.title=r,new ctrl.topBar({isIndex:!1,title:r}),this.proType=parseInt(t.proType)||0,this.code=t.code||0,this.id=t.id||0,this.value=t.value||0,this.duringPay=!1,lib.lazyload.init(),this.addEvents(),this.render(),this.bottombar=new ctrl.bottomBar({showBottom:!0});var o=window.navigator.userAgent.toLowerCase();o.match(/MicroMessenger/i)?e(".weixinpay").css("display","block"):e(".weixinpay").hide(),new lib.goTop},addEvents:function(){var i=this;e(".radio").on("click",function(){if(!e(this).hasClass("radio-active")){var i=e(this).attr("name");e(".radio[name="+i+"]").removeClass("radio-active"),e(this).addClass("radio-active")}}),e(".delivery-title").on("click",function(){e(this).find(".arrow-right").hasClass("arrow-down")?(e(this).find(".arrow-right").removeClass("arrow-down"),e(".delivery-content").hide()):(e(this).find(".arrow-right").addClass("arrow-down"),e(".delivery-content").show())}),e(".delivery-content .radio").unbind("click"),e(".delivery-content .select-row").on("click",function(){e(this).find(".radio-active")[0]||(console.log("change"),e(".delivery-content .radio-active").removeClass("radio-active"),e(this).find(".radio").addClass("radio-active"),e(".delivery-text").html(e(this).text())),e(".delivery-content").hide(),e(".delivery-title .arrow-right").removeClass("arrow-down")}),e(".invoice-title").on("click",function(){e(this).find(".arrow-right").hasClass("arrow-down")?(e(this).find(".arrow-right").removeClass("arrow-down"),e(".invoice-content").hide()):(e(this).find(".arrow-right").addClass("arrow-down"),e(".invoice-content").show())}),e(".payinfo").on("click",function(){var t=20,r=null;if("alipay"==e(this).attr("paytype")?t=20:"wxpay"==e(this).attr("paytype")&&(t=25,r="http://pay.api.ve.cn"),!i.duringPay)if(i.duringPay=!0,i.paragram={source:"h5",in_app:0,order_type:i.proType-0+1},i.paragram.pay_type=t,i.paragram.addr_id=e(".address-container").attr("data-id"),i.paragram.mess=e(".delivery-text").text(),i.code&&(i.paragram.code=i.code),i.id&&(i.paragram.coupon_id=i.id),i.paragram.is_invoices=e('.invoice-content .radio-active[name="type"]').index()>1?1:0,i.paragram.is_invoices&&(i.paragram.invoices_type=e('.invoice-content .radio-active[name="type"]').index()-2,i.paragram.invoices_cpy=e(".invoice-content .invoice-input").val(),i.paragram.invoices_class=e('.invoice-content .radio-active[name="content"]').index()),i.paragram.addr_id)lib.api.get({api:{c:"order",a:"add_User_Order"},needLogin:!0,apiUrl:r,data:i.paragram,success:function(e){console.log(e),lib.h5log.log(["setCustomVariable",5,"orderSn",e.order_sn,"page"]),setTimeout(function(){window.location.href=e.html_url},100)},error:function(e){var i=lib.notification.alert(e.desc,function(){this.hide()},{useTap:!0});i.show()},complete:function(){i.duringPay=!1}});else{var o=lib.notification.alert("请添加收货地址",function(){this.hide()},{useTap:!1});o.show()}})},render:function(){var i=this;i.isAjax||(i.isAjax=!0,lib.api.get({api:{c:"shoping",a:"get_User_Cart"},needLogin:lib.login.isLogin(),data:{accessToken:""},success:function(t){if(console.log(t),i.proType&&!t.is_sea_order){var r=lib.notification.alert(t.sea_limit_message,function(){this.hide(),window.location.href="cart.html?type=2"},{useTap:!0});r.show()}var o=i.proType?t.sea_products:t.products;o&&o[0]?(i.renderNext(),i.renderItems(t),i.renderSum(t),i.renderCoupon(t),e(".coupon-row").attr("href","coupon-select.html?total="+(i.proType?t.sea_total_price:t.total_price)+(i.code?"&code="+i.code:"")+(i.proType?"&proType=1":""))):window.location.href="order-list.html#status=1"},error:function(e){var i=lib.notification.alert(e.desc,function(){this.hide(),window.location.href="order-list.html"},{useTap:!0});i.show()},complete:function(){i.isAjax=!1}}))},renderNext:function(){var i=this;lib.login.isLogin()?lib.login.isLogin()?lib.api.get({api:{c:"user",a:"getaddress"},needLogin:!0,data:{},success:function(t){console.log(t),lib.storage.set("addressList",t);var r=t.addresses[0];if(lib.storage.get("addressSelectedId"))for(var o=0;o<t.addresses.length;o++)t.addresses[o].id==lib.storage.get("addressSelectedId")&&(r=t.addresses[o]);i.renderAddress(r),e(".container").show(),e(".loading").hide()},error:function(t){(t.code="00007")&&(i.renderAddress(),e(".container").show(),e(".loading").hide())},complete:function(){i.isAjax=!1}}):i.renderAddress():(i.renderAddress(),e(".container").show(),e(".loading").hide())},checkNeedScroll:function(){return!this.is_have},renderAddress:function(i){var t=e("#address"),r=this,o=e("#tpl-address").html();t.prepend(_.template(o)({addressData:i,proType:r.proType,isLogin:lib.login.isLogin()}))},renderItems:function(i){var t=this.proType?i.sea_products:i.products;for(var r in t){var o=0;for(var a in t[r].orders)o+=t[r].orders[a].price*t[r].orders[a].num;t[r].sum=o}var n=this.proType?i.sea_total_price:i.total_price,s=e("#orders"),d=e("#tpl-goods").html();s.append(_.template(d)({products:t,proType:this.proType,total_price:n})),lib.lazyload.trigger()},renderSum:function(i){var t=e(".pay-container"),r=e("#tpl-pay").html();t.prepend(_.template(r)({data:i,value:this.value,proType:this.proType}))},renderCoupon:function(i){var t=e(".coupon-container"),r=e("#tpl-coupon").html(),o=lib.login.isLogin();t.prepend(_.template(r)({data:i,proType:this.proType,isLogin:o})),this.code&&(e(".coupon-row .unselected").remove(),e(".coupon-row").append('<span class="select-content">'+this.value+"元优惠券</span>"))},renderError:function(e){switch(e){case"param":this.showTip("缺少必要参数");break;case"network":this.showTip("服务器开小差啦");break;case"empty":this.showTip("当前条件，列表为空")}},showTip:function(i){var t=e(".info-tip");t.html(i).show()}};e(function(){i.init()})}(Zepto,window.Global||(window.Global={}));