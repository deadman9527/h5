!function(t){Global.formatImgSrc=function(t){if(!t)return"http://h5.quxiu.me/assets/img/cart_img_black_640x253.png";var i=t.match(/^http:\/\/img\.ve\.cnttp(.+)_3\.jpg/);return i?"http"+i[1]+".jpg":t},Global.discount=function(t){var i=new Date(1e3*t),e=i.getFullYear(i),n=i.getMonth(i)+1,o=i.getDate(i),s=i.getHours(i),a=i.getMinutes(i),r=i.getSeconds(i);return e+"-"+n+"-"+o+" "+s+":"+a+":"+r};var i={init:function(){var i=new lib.httpurl(location.href),e=i.params,n=e.title?decodeURIComponent(e.title):"我的订单";document.title=n,new ctrl.topBar({isIndex:!1,title:n}),this.bottombar=new ctrl.bottomBar({hoverIndex:3,showBottom:!0}),this.is_have=e.is_have||0,this.page=1,this.status=parseInt(window.location.hash.split("status=")[1])||0,t(".order-status").eq(this.status).find("p").addClass("active"),lib.lazyload.init();var o=this;this.infiniteScroll=lib.infiniteScroll.init({bufferPx:150,time:200,onNear:function(){o.render()},end:function(){return o.isEnd}}),this.addEvents(),this.render(!0),new lib.goTop({position:{bottom:60}})},addEvents:function(){var i=this;t(".order-status").on("click",function(){t(this).find("p").hasClass("active")||(window.location.hash="status="+t(this).index(),t(".order-status p").removeClass("active"),t(this).find("p").addClass("active"))}),window.addEventListener("hashchange",function(){i.status=parseInt(window.location.hash.split("status=")[1])||0,t(".order-status p").removeClass("active"),t(".order-status").eq(i.status).find("p").addClass("active"),i.render(!0)})},addEventsLink:function(){t(".detail-link").on("click",function(){var i=t(this).attr("data-id"),e="order-detail.html?orderSn="+i;3==t(".active").parent().index()&&(e+="&fromUseless=1"),window.location.href=e}),t(".show").on("click",function(){t(this).closest(".order-container").find(".hidden").removeClass("hidden"),t(this).addClass("hidden")}),t(".hide").on("click",function(){t(this).closest(".order-container").find("ul li").addClass("hidden").eq(0).removeClass("hidden"),t(".show").removeClass("hidden"),t(this).addClass("hidden")})},render:function(i){if(!lib.login.isLogin())return void lib.login.goLogin();var e=this;e.isAjax||(i&&(this.page=1,this.infiniteScroll.remove(),t("#orders").empty(),this.showTip("数据加载中...")),e.isAjax=!0,lib.api.get({api:{c:"order",a:"orderlist"},needLogin:!0,data:{page:this.page,status:this.status},success:function(t){console.log(e.page),console.log(t),Array.isArray(t.orders)?(e.hideTip(),e.renderItems(t.orders),t.orders.length||1!=e.page?e.checkNeedScroll()&&!e.infiniteScroll.started&&e.infiniteScroll.start():e.showTip("该状态还没有订单~")):1==e.page?e.renderError("empty"):e.isEnd=!0,e.page++,e.addEventsLink(),e.discount()},error:function(t){"10007"==t.code&&(e.infiniteScroll.remove(),1==e.page&&e.showTip("该状态还没有订单~"))},complete:function(){e.isAjax=!1}}))},discount:function(){var i=this;t(".order-discount")[0]&&t(".order-discount span").each(function(e,n){var o=parseInt(t(n).attr("data")),s=setInterval(function(){if(o--,0>=o)i.render(!0),clearInterval(s);else{var e=Math.floor(o/60),a=o%60;t(n).text((e>9?e:"0"+e)+":"+(a>9?a:"0"+a))}},1e3)})},checkNeedScroll:function(){return!this.is_have},renderItems:function(i){t(".info-tip").hide(),console.log(this.status);var e=t("#orders"),n=t("#tpl-item").html();e.append(_.template(n)({itemList:i,status:this.status})),this.addEventsAction(),lib.lazyload.trigger()},addEventsAction:function(){var i=this;t(".pay").on("click",function(){var e=t(this).closest(".order-container").find(".detail-link").attr("data-id");if(!i.payAjax){i.payAjax=!0;var n=window.navigator.userAgent.toLowerCase(),o=20,s=null;n.match(/MicroMessenger/i)?(o=25,s="http://pay.api.ve.cn"):o=20,lib.api.get({api:{c:"pay",a:"payOrder"},needLogin:!0,apiUrl:s,data:{pay_type:o,in_app:0,order_sn:e},success:function(t){console.log(t),window.location.href=t.html_url},error:function(t){console.log(t);var i=lib.notification.alert(t.desc,function(){this.hide()},{useTap:!0});i.show()},complete:function(){i.payAjax=!1}})}}),t(".logistic").on("click",function(){var i=t(this).closest(".order-container").find(".detail-link").attr("data-id");window.location.href="logistics.html?order_sn="+i})},renderError:function(t){switch(t){case"param":this.showTip("缺少必要参数");break;case"network":this.showTip("服务器开小差啦");break;case"empty":this.showTip("当前条件，列表为空")}},showTip:function(i){var e=t(".info-tip");e.html(i).show()},hideTip:function(){var i=t(".info-tip");i.html("").hide()}};t(function(){i.init()})}(Zepto,window.Global||(window.Global={}));