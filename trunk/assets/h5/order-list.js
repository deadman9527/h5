!function(a){Global.formatImgSrc=function(a){if(!a)return"http://h5.ve.cn/assets/img/cart_img_black_640x253.png";var b=a.match(/^http:\/\/img\.ve\.cnttp(.+)_3\.jpg/);return b?"http"+b[1]+".jpg":a},Global.discount=function(a){var b=new Date(1e3*a),c=b.getFullYear(b),d=b.getMonth(b)+1,e=b.getDate(b),f=b.getHours(b),g=b.getMinutes(b),h=b.getSeconds(b);return c+"-"+d+"-"+e+" "+f+":"+g+":"+h};var b={init:function(){var b=new lib.httpurl(location.href),c=b.params,d=c.title?decodeURIComponent(c.title):"我的订单";document.title=d,new ctrl.topBar({isIndex:!1,title:d}),this.bottombar=new ctrl.bottomBar({showBottom:!0}),this.is_have=c.is_have||0,this.page=1,this.status=parseInt(window.location.hash.split("status=")[1])||0,a(".order-status").eq(this.status).find("p").addClass("active"),lib.lazyload.init();var e=this;this.infiniteScroll=lib.infiniteScroll.init({bufferPx:150,time:200,onNear:function(){e.render()},end:function(){return e.isEnd}}),this.addEvents(),this.render(!0),new lib.goTop({position:{bottom:60}})},addEvents:function(){var b=this;a(".order-status").on("click",function(){a(this).find("p").hasClass("active")||(window.location.hash="status="+a(this).index(),a(".order-status p").removeClass("active"),a(this).find("p").addClass("active"))}),window.addEventListener("hashchange",function(){b.status=parseInt(window.location.hash.split("status=")[1])||0,a(".order-status p").removeClass("active"),a(".order-status").eq(b.status).find("p").addClass("active"),b.render(!0)})},addEventsLink:function(){a(".detail-link").on("click",function(){var b=a(this).attr("data-id"),c="order-detail.html?orderSn="+b;3==a(".active").parent().index()&&(c+="&fromUseless=1"),window.location.href=c}),a(".show").on("click",function(){a(this).closest(".order-container").find(".hidden").removeClass("hidden"),a(this).addClass("hidden")}),a(".hide").on("click",function(){a(this).closest(".order-container").find("ul li").addClass("hidden").eq(0).removeClass("hidden"),a(".show").removeClass("hidden"),a(this).addClass("hidden")})},render:function(b){if(!lib.login.isLogin())return void lib.login.goLogin();var c=this;c.isAjax||(b&&(this.page=1,this.infiniteScroll.remove(),a("#orders").empty(),this.showTip("数据加载中...")),c.isAjax=!0,lib.api.get({api:{c:"order",a:"orderlist"},needLogin:!0,data:{page:this.page,status:this.status},success:function(a){console.log(c.page),console.log(a),Array.isArray(a.orders)?(c.hideTip(),c.renderItems(a.orders),a.orders.length||1!=c.page?c.checkNeedScroll()&&!c.infiniteScroll.started&&c.infiniteScroll.start():c.showTip("该状态还没有订单~")):1==c.page?c.renderError("empty"):c.isEnd=!0,c.page++,c.addEventsLink(),c.discount()},error:function(a){"10007"==a.code&&(c.infiniteScroll.remove(),1==c.page&&c.showTip("该状态还没有订单~"))},complete:function(){c.isAjax=!1}}))},discount:function(){var b=this;a(".order-discount")[0]&&a(".order-discount span").each(function(c,d){var e=parseInt(a(d).attr("data")),f=setInterval(function(){if(e--,0>=e)b.render(!0),clearInterval(f);else{var c=Math.floor(e/60),g=e%60;a(d).text((c>9?c:"0"+c)+":"+(g>9?g:"0"+g))}},1e3)})},checkNeedScroll:function(){return!this.is_have},renderItems:function(b){a(".info-tip").hide(),console.log(this.status);var c=a("#orders"),d=a("#tpl-item").html();c.append(_.template(d)({itemList:b,status:this.status})),this.addEventsAction(),lib.lazyload.trigger()},addEventsAction:function(){var b=this;a(".pay").on("click",function(){var c=a(this).closest(".order-container").find(".detail-link").attr("data-id");if(!b.payAjax){b.payAjax=!0;var d=window.navigator.userAgent.toLowerCase(),e=20,f=null;d.match(/MicroMessenger/i)?(e=25,f="http://pay.api.ve.cn"):e=20,lib.api.get({api:{c:"pay",a:"payOrder"},needLogin:!0,apiUrl:f,data:{pay_type:e,in_app:0,order_sn:c},success:function(a){console.log(a),window.location.href=a.html_url},error:function(a){console.log(a);var b=lib.notification.alert(a.desc,function(){this.hide()},{useTap:!0});b.show()},complete:function(){b.payAjax=!1}})}}),a(".logistic").on("click",function(){var b=a(this).closest(".order-container").find(".detail-link").attr("data-id");window.location.href="logistics.html?order_sn="+b})},renderError:function(a){switch(a){case"param":this.showTip("缺少必要参数");break;case"network":this.showTip("服务器开小差啦");break;case"empty":this.showTip("当前条件，列表为空")}},showTip:function(b){var c=a(".info-tip");c.html(b).show()},hideTip:function(){var b=a(".info-tip");b.html("").hide()}};a(function(){b.init()})}(Zepto,window.Global||(window.Global={}));