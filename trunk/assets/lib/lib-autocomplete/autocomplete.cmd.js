!function(win,lib){function getParam(a){var b=$("#J_search .cc-search-tab li.cur").html(),c="宝贝"==b?"hbword":"店铺"==b?"hshopword":"tmallword";return c=c+a+"%23h%23search"}var localStorage;try{localStorage=win.localStorage,localStorage.setItem("@private","false")}catch(e){localStorage=null}var $=win.$,queueHandler=function(){var a=this,b=setInterval(function(){if(a.Queue.length>0&&!a.stop){var c=a.Queue.shift();c.fn(c.argument),c.callBack&&c.callBack()}else clearInterval(b)},this.setTimeout)},queue={Queue:[],syncQueue:[],setTimeout:100,add:function(a,b,c){return this.Queue.push({fn:a,argument:b,callBack:c}),this},addSync:function(a,b,c){return this.syncQueue.push({fn:a,argument:b,callBack:c}),this},clear:function(){return this.Queue=[],this},stop:!1,start:function(){return this.stop=!1,this.setTimeout>0&&queueHandler.apply(this),this},shift:function(){},dequeue:function(){var a=this.syncQueue.shift();a&&(a.fn(a.argument),a.callBack&&a.callBack())}};$.fn.autoComplete=function(options){var self=this,setting={ajaxUrl:"http://m.taobao.com",operator:".J_autocomplete",cat:".J_cat",wrapEl:".wrap",meatEl:".meat",childEl:"li",submit:".btn",close:".close",collapse:"collapse",expand:"expand",delay:0,anim:!0,isUseKey:!0,history:!1,localStorage:"searchhistory",clearHistory:"clear",addition:!1,additionClass:".addition",max:7,onFocus:function(){},afterItemClick:function(){},textInput:function(){},onHisLoad:function(){}};$.extend(setting,options||{});var autoComplete={ajax:[],hisList:[],hisIndex:0,onHisLoad:setting.onHisLoad};return $(this).each(function(){function initInput(a){var b,a=a||window.event;if(b=$(this).val().replace(/(^\s+)|(\s+$)/g,""),!b.length&&setting.history)return queue.clear(),queue.add(getHistory),void queue.start();if(13!=a.keyCode&&32!=a.keyCode){setting.textInput.call(this,b.length);var c=self.find("#J_ST"),d=c.attr("name");return c.length>0&&"event_submit_do_search_shop"==d?(self.find(setting.wrapEl).hide(),!1):void("close"!==setting.status&&(queue.clear(),queue.add(getList,b),queue.start()))}}function getList(a){var b=setting.ajaxUrl;autoComplete.ajax.push($.ajax({url:b,type:"GET",dataType:"jsonp",data:"code=utf-8&extras=1&q="+a,error:function(){return!1},success:function(a){pack(a),$close.html("关闭").removeClass("clear")}}))}function getHistory(){var a=autoComplete.hisList[autoComplete.hisIndex];pack(a),$close.html("清除历史记录").addClass("clear")}function clearHistory(){if(setting.localStorage&&localStorage)localStorage.removeItem(setting.localStorage);else{var a="string"==typeof setting.clearHistory?[setting.clearHistory]:setting.clearHistory;queue.clear();for(var b=0;b<a.length;b++)queue.addSync($.ajax,{url:a[b],dataType:"jsonp",success:function(){queue.dequeue()}});queue.dequeue()}autoComplete.hisList=[]}function pack(a){var b=[],c=[],d=[],e=[],f=a&&a.minitao,g=a&&a.cat,h=a&&a.result,i=!1;if(setting.isUseKey&&self.find("#J_IsUseSearchSuggest").val(""),setting.status||(setting.status=a&&a.result&&0===a.result.length?"close":a&&a.status),f){for(var j=0;j<f.length;j++){var k=f[j][0],l=Number(f[j][1]),m=f[j][2];l>=1e4&&(l/=1e4,l=l.toFixed(1)+"万"),c.push('<li class="we" key="'+m+'">'),c.push('<div class="logo we"></div>'),c.push('<div class="title"> <span class="grey name">微淘</span> <span>'+k+'</span> <span class="grey type">'+l+"关注者</span></div>"),c.push('<div class="arrow"></div>'),c.push("</li>")}i=!0}if(g){for(var n=0;n<g.length;n++){var o=g[n][2],p=g[n][1],q=g[n][0];c.push('<li catmap="'+p+'" key="'+o+'">'),c.push('<div class="logo cat"></div>'),c.push('<div class="title"><span>'+o+'</span> <span class="grey name">分类</span> <span class="grey type">'+q+"</span></div>"),c.push('<div class="arrow"></div>'),c.push("</li>")}i=!0}if(a&&0!=a.result&&a.result.length>0){for(var r=h.length>setting.max?setting.max:h.length,j=(setting.addition?"<div class='"+setting.additionClass.slice(1)+"'></div>":"",0);r>j;j++)e.push('<li key="'+h[j][0]+'"><div class="title">'+h[j][0]+"</div></li>");i=!0}return i?(b.push(d.join("")+c.join("")+e.join("")),self.find(setting.meatEl).html(b.join("")),effect(),void 0):void self.find(setting.wrapEl).hide()}function effect(){var a=null;a=setTimeout(function(){setting.anim?self.find(setting.wrapEl).show():self.removeClass(setting.collapse).addClass(setting.expand)},setting.delay),self.find(setting.close).unbind("click"),self.find(setting.childEl).unbind("click"),self.find(setting.close).click(function(){var a=null;a=setTimeout(function(){setting.anim?self.find(setting.wrapEl).hide():self.removeClass(setting.expand).addClass(setting.collapse)},setting.delay),$close.hasClass("clear")&&(logAjax("","clean"),clearHistory())}),self.find(setting.childEl).click(function(){var a=$(this),b=a.attr("key"),c=a.attr("catmap")||"";if(setting.afterItemClick.call(this,Number(a.index())+1),a.hasClass("we"))location.href="http://h5.m.taobao.com/we/index.htm#account/"+b;else{operator.val(b),$(setting.cat).val(c);var d=self.find(setting.submit)[0];d&&d.click()}})}function toTop(){return}function logAjax(a,b){var c="http://log.mmstat.com/search",d=document.cookie,e=d&&d.match("_w_tb_nick=.*"),f=b||"",g=e&&e[0].split(";")[0].split("=")[1]||"",h="smtaobao",i=a||"",j="sug";$.ajax({url:c,data:{op:f,nk:g,src:h,q:i,app:j},error:function(){return console.log("网络连接失败，请刷新页面重试"),!1},success:function(){}})}var self=$(this);if(setting.history)if(setting.localStorage&&localStorage)autoComplete.hisList=eval(localStorage.getItem(setting.localStorage)||[]);else{for(var hisArray="string"==typeof setting.history?[setting.history]:setting.history,i=0;i<hisArray.length;i++)queue.addSync($.ajax,{url:hisArray[i],type:"GET",dataType:"jsonp",error:function(){return console.log("网络连接失败，请刷新页面重试"),!1},success:function(a){autoComplete.hisList.push(a),queue.dequeue()}});queue.addSync(autoComplete.onHisLoad),queue.dequeue()}var operator=$(this).find(setting.operator),$close=self.find(setting.close).addClass("c-btn-grey-small s-btn-grey");operator.attr("autocomplete","off"),operator.on("input",initInput),operator.focus(function(a){var b;return""==$(this).val()&&$(this).val(""),b=$(this).val().replace(/(^\s+)|(\s+$)/g,""),setting.onFocus&&setting.onFocus.call(operator,a,b),0==b.length&&setting.history?(queue.clear(),queue.add(getHistory),void queue.start()):void 0}),setting.addition&&self.find(setting.meatEl).on("touchstart click","div"+setting.additionClass,function(a){var b=$(this);operator.focus(),operator.val(b.parent().attr("key")),initInput.call(operator),a.preventDefault(),a.stopPropagation()}),autoComplete.getHistory=setting.history?function(){queue.clear(),queue.add(getHistory),queue.start()}:function(){},autoComplete.close=function(){if(queue.clear(),autoComplete.ajax.length){for(i=0;i<autoComplete.ajax.length;i++)autoComplete.ajax[i]&&autoComplete.ajax[i].abort();autoComplete.ajax=[]}self.find(setting.wrapEl).hide()},autoComplete.initInput=initInput}),autoComplete},lib.autocomplete={template:['<section id="J_search" class="in-search cc-search showoff">','<div class="cc-search-hide">','<a class="cc-back">关闭</a>','<ul class="cc-search-tab">','<li class="cur" i="event_submit_do_new_search_auction">宝贝</li>','<li i="event_submit_do_search_shop">店铺</li>','<li i="event_submit_do_new_search_tmall_auction">天猫</li>',"</ul>","</div>",'<div id="J_dropdown" class="c-form-suggest">','<div class="c-form-search">','<form id="J_indexform" name="wapSearchForm" action="http://s.m.taobao.com/h5.htm?pds=hbword0%23h%23search" method="get" autocomplete="off">','<input id="J_searchtext" class="inp-search" name="q" value="" autocomplete="off" />','<a id="J_cleartext" class="clearText"><span></span></a>','<input type="submit" value="" name="search-bton" class="bton-search" />','<input type="hidden" id="J_ST" name="event_submit_do_new_search_auction" value="1" />','<input type="hidden" value="utf-8" name="_input_charset" />','<input type="hidden" value="1" name="topSearch" />','<input type="hidden" value="b" name="atype" />','<input type="hidden" value="1" name="searchfrom" />','<input type="hidden" value="home:redirect_app_action" name="action" />','<input type="hidden" value="1" name="from" />','<input type="hidden" name="ttid" />',"</form>","</div>",'<div class="suggest"><ul class="meat"></ul><span class="close">关闭</span></div>',"</div>","</section>"].join(""),init:function(a,b){$(this.template).appendTo(document.body),b||(b={});var c=$("#J_dropdown").autoComplete({ajaxUrl:"http://suggest.taobao.com/sug",wrapEl:".suggest",operator:".inp-search",meatEl:".suggest .meat",close:".suggest .close",submit:".bton-search",addition:!0,anim:!0,history:!0,clearHistory:!0,onFocus:function(){e.val(""),d.removeClass("showoff"),$(a).hide()},textInput:function(){e.val().length?f.css("visibility","visible"):f.css("visibility","hidden")},afterItemClick:function(a){var b=getParam(a);g.attr("action","http://s.m.taobao.com/h5?pds="+b+"&suggest="+encodeURIComponent($(this).text())+"_"+a+"&q="+encodeURIComponent($(this).text()))}}),d=$("#J_search"),e=$("#J_searchtext"),f=$("#J_cleartext"),g=$("#J_indexform"),h=$("#J_ST");e.attr("placeholder",b.title||""),d.on("click","#J_cleartext",function(){e.val(""),f.css("visibility","hidden"),d.find(".suggest").hide()}),d.on("click",".cc-back",function(){d.addClass("showoff"),$(a).show()}),d.on("click",".cc-search-tab li",function(){var a=$(this),b=a.attr("i");if(!a.hasClass("cur"))switch(h[0].setAttribute("name",b),a.addClass("cur").siblings(".cur").removeClass("cur"),g.attr("action","http://s.m.taobao.com/index.htm?pds="+getParam(0)),a.html()){case"店铺":c.hisIndex=1,c.getHistory();break;case"天猫":c.hisIndex=2,c.getHistory();break;default:c.hisIndex=0,c.getHistory()}}),d.on("submit","#J_indexform",function(){var a=e[0];b.searchkey||(b.searchkey="");var d=a.value?a.value:b.searchkey;if(a.value=d,""===d)return notification.simple("请输入关键字"),!1;if($("#J_indexform").attr("action",$("#J_indexform").attr("action")),localStorage){var f="searchhistory";ls=localStorage.getItem(f);var g=ls&&JSON.parse(ls)||[],h=c.hisIndex,i=g.length>h&&g[h]||{result:[]},j=$.map(i.result,function(a,b){return a[0]==d||b>6?null:[a]});j.unshift([d]),i.result=j,g[h]=i,localStorage.setItem(f,JSON.stringify(g))}})}}}(window,window.lib||(window.lib={}));
if (window.KISSY) {KISSY.add('mtb/lib-autocomplete/0.1.0/autocomplete.cmd',function() {return window.lib.autocomplete;},{requries:['mtb/zepto']});} else if ('undefined' !== typeof define) {define('mtb/lib-autocomplete/0.1.0/autocomplete.cmd', [], function(){require('mtb/zepto');return window.lib.autocomplete;});}